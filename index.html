<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>幾何繪圖學習工具</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; background: #f0f2f5; }
        .controls { background: white; padding: 15px; border-radius: 8px; margin: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #canvas-container { 
            width: 90vw; max-width: 700px; aspect-ratio: 1 / 1; 
            background: white; border: 2px solid #ccc; position: relative;
            /* 輔助格線背景 */
            background-image: linear-gradient(#e5e5e5 1px, transparent 1px), linear-gradient(90deg, #e5e5e5 1px, transparent 1px);
        }
        #infoPanel { margin-top: 15px; padding: 15px; background: #fffde7; border: 1px solid #ffe082; width: 90%; max-width: 700px; }
        canvas { display: block; }
    </style>
</head>
<body>

<div class="controls">
    <select id="gridSize">
        <option value="5">5x5</option>
        <option value="9">9x9</option>
        <option value="16">16x16</option>
    </select>
    <button onclick="undoLastLine()">清除最後一條線</button>
    <button onclick="clearCanvas()">全部清除</button>
</div>

<div id="canvas-container">
    <canvas id="gridCanvas"></canvas>
</div>

<div id="infoPanel">選擇網格並開始繪製圖形，系統將自動分析。</div>

<script>
    const canvas = document.getElementById('gridCanvas');
    const ctx = canvas.getContext('2d');
    const container = document.getElementById('canvas-container');
    let gridSize = 5, points = [], lines = [], startPoint = null, mousePos = {x: 0, y: 0};

    function init() {
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
        const spacing = canvas.width / gridSize;
        // 設定背景格線密度
        container.style.backgroundSize = `${spacing}px ${spacing}px`;
        
        points = [];
        for(let i=0; i<gridSize; i++) {
            for(let j=0; j<gridSize; j++) {
                points.push({x: spacing/2 + j * spacing, y: spacing/2 + i * spacing});
            }
        }
        draw();
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        points.forEach(p => { ctx.fillStyle = "#999"; ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fill(); });

        lines.forEach(line => {
            ctx.beginPath(); ctx.moveTo(line.start.x, line.start.y); ctx.lineTo(line.end.x, line.end.y);
            ctx.strokeStyle = "#333"; ctx.lineWidth = 3; ctx.stroke();
        });

        if (startPoint) {
            ctx.beginPath(); ctx.moveTo(startPoint.x, startPoint.y); ctx.lineTo(mousePos.x, mousePos.y);
            ctx.setLineDash([5,5]); ctx.strokeStyle = "red"; ctx.stroke(); ctx.setLineDash([]);
        }
    }

    canvas.addEventListener('mousemove', (e) => {
        const rect = canvas.getBoundingClientRect();
        mousePos = {x: e.clientX - rect.left, y: e.clientY - rect.top};
        draw();
    });

    canvas.addEventListener('click', (e) => {
        const rect = canvas.getBoundingClientRect();
        const mx = e.clientX - rect.left, my = e.clientY - rect.top;
        const clickedPoint = points.find(p => Math.hypot(p.x - mx, p.y - my) < 30);
        
        if (clickedPoint) {
            if (startPoint) {
                lines.push({start: startPoint, end: clickedPoint});
                updateAnalysis();
                startPoint = null;
            } else { startPoint = clickedPoint; }
        }
        draw();
    });

    function updateAnalysis() {
        const count = lines.length;
        let info = `目前繪製了 ${count} 條線段。`;
        if (count >= 3) {
            info += `<br><strong>圖形提示：</strong> 這可能是一個多邊形。試著閉合圖形來計算面積與周長！`;
            info += `<br><em>面積小技巧：</em> 試著數數看圖形內部佔了多少個小方格。`;
        }
        document.getElementById('infoPanel').innerHTML = info;
    }

    function undoLastLine() { lines.pop(); draw(); }
    function clearCanvas() { lines = []; startPoint = null; draw(); }

    document.getElementById('gridSize').addEventListener('change', () => { gridSize = parseInt(document.getElementById('gridSize').value); init(); });
    window.addEventListener('resize', init);
    init();
</script>
</body>
</html>
